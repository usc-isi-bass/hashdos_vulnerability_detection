import os
from nose.tools import *
import tempfile
import shutil
import subprocess
import re
import logging

import angr
import claripy

from hash_patcher.static_patcher import StaticPatcher
from hash_patcher.hash_func_evaluator import HashFuncEvaluatorSig1,HashFuncEvaluatorSig2

logging.getLogger('angr').setLevel(logging.CRITICAL)
logging.getLogger('cle').setLevel(logging.CRITICAL)
logging.getLogger('claripy').setLevel(logging.CRITICAL)
logging.getLogger('claripy.balancer').setLevel(logging.CRITICAL)
logging.getLogger('pyvex').setLevel(logging.CRITICAL)
logging.getLogger('pyvex.lifting.libvex').setLevel(logging.CRITICAL)
logging.getLogger('archinfo.arch').setLevel(logging.CRITICAL)



test_location = os.path.join(os.path.dirname(os.path.realpath(__file__)), '..', '..', 'test_binaries')
test_data_location = os.path.join(os.path.dirname(os.path.realpath(__file__)), '..', '..', 'hash_patches')

def test_evaluate_ext_mem_refs_bkdr_sig1():
    #hash_vals = [5862996, 2090848505, 177671, 5862526, 5862562, 193506295, 279502731, 195545384, 177679, 203161375, 278452749, 5861855, 177623, 257214844, 2089171668, 240614700, 193492085, 2090973105, 193456215, 234507439, 193459414, 193467829, 217301837, 177644, 223910547, 2088581065, 228373217, 193492735, 193473642, 193487267]
    hash_vals = [5862996, 2090848505, 177671, 5862526]
    check_elf_and_hash('hash_funcs_sig1', 'BKDRHash', hash_vals, 'sig1')

def test_evaluate_ext_mem_refs_bkdr_sig2():
    #hash_vals = [5862996, 2090848505, 177671, 5862526, 5862562, 193506295, 279502731, 195545384, 177679, 203161375, 278452749, 5861855, 177623, 257214844, 2089171668, 240614700, 193492085, 2090973105, 193456215, 234507439, 193459414, 193467829, 217301837, 177644, 223910547, 2088581065, 228373217, 193492735, 193473642, 193487267]
    hash_vals = [5862996, 2090848505, 177671, 5862526]
    check_elf_and_hash('hash_funcs_sig2', 'BKDRHash', hash_vals, 'sig2')

def test_evaluate_ext_mem_refs_dek_sig1():
    #hash_vals = [821, 8181177, 66, 492, 464, 23366, 227132025, 155039446, 74, 161685866, 228303332, 3937, 18, 209566855, 6652499, 257798961, 5844, 8165233, 39795, 254526049, 44753, 52722, 241232933, 103, 247157411, 6052017, 251029137, 10602, 54038, 1396]
    hash_vals = [821, 8181177, 66, 492]
    check_elf_and_hash('hash_funcs_sig1', 'DEKHash', hash_vals, 'sig1')

def test_evaluate_ext_mem_refs_dek_sig2():
    #hash_vals = [821, 8181177, 66, 492, 464, 23366, 227132025, 155039446, 74, 161685866, 228303332, 3937, 18, 209566855, 6652499, 257798961, 5844, 8165233, 39795, 254526049, 44753, 52722, 241232933, 103, 247157411, 6052017, 251029137, 10602, 54038, 1396]
    hash_vals = [821, 8181177, 66, 492]
    check_elf_and_hash('hash_funcs_sig2', 'DEKHash', hash_vals, 'sig2')

def test_evaluate_ext_mem_refs_pjw_sig1():
    #hash_vals = [1557, 506873, 98, 1308, 1344, 31174, 8148857, 3596198, 106, 3981018, 8102436, 977, 50, 7004839, 317315, 6092465, 27844, 527569, 19667, 5805137, 20129, 22050, 4754805, 71, 5163955, 248017, 5390769, 27882, 23494, 26868]
    hash_vals = [1557, 506873, 98, 1308]
    check_elf_and_hash('hash_funcs_sig1', 'PJWHash', hash_vals, 'sig1')

def test_evaluate_ext_mem_refs_pjw_sig2():
    #hash_vals = [1557, 506873, 98, 1308, 1344, 31174, 8148857, 3596198, 106, 3981018, 8102436, 977, 50, 7004839, 317315, 6092465, 27844, 527569, 19667, 5805137, 20129, 22050, 4754805, 71, 5163955, 248017, 5390769, 27882, 23494, 26868]
    hash_vals = [1557, 506873, 98, 1308]
    check_elf_and_hash('hash_funcs_sig2', 'PJWHash', hash_vals, 'sig2')

def test_evaluate_ext_mem_refs_rs_sig1():
    #hash_vals = [899633147, 1113437542, 98, 1008295407, 1008295443, 1759695690, 3664742206, 4173106753, 106, 2861657620, 1393987696, 4148907064, 50, 1047466381, 2848005345, 3746195921, 1135814658, 3790230258, 55585360, 2846076012, 1839108415, 4265368862, 839169216, 71, 3702649104, 520884440, 3901536316, 4078420170, 3555744417, 2329774954]
    hash_vals = [899633147, 1113437542, 98, 1008295407]
    check_elf_and_hash('hash_funcs_sig1', 'RSHash', hash_vals, 'sig1')

def test_evaluate_ext_mem_refs_rs_sig2():
    #hash_vals = [899633147, 1113437542, 98, 1008295407, 1008295443, 1759695690, 3664742206, 4173106753, 106, 2861657620, 1393987696, 4148907064, 50, 1047466381, 2848005345, 3746195921, 1135814658, 3790230258, 55585360, 2846076012, 1839108415, 4265368862, 839169216, 71, 3702649104, 520884440, 3901536316, 4078420170, 3555744417, 2329774954]
    hash_vals = [899633147, 1113437542, 98, 1008295407]
    check_elf_and_hash('hash_funcs_sig2', 'RSHash', hash_vals, 'sig2')

def test_evaluate_ext_mem_refs_js_sig1():
    #hash_vals = [2762492226, 1110201004, 2935291980, 2762493689, 2762493661, 446421559, 337890280, 1677516465, 2935291988, 1611191246, 336721251, 2762493087, 2935291932, 1664134994, 1082640696, 1634480176, 446381510, 1110279722, 446399127, 1701216367, 446451528, 446460671, 1623919891, 2935292023, 1695673258, 1086324297, 1614930923, 446379991, 446413526, 446365814]
    hash_vals = [2762492226, 1110201004, 2935291980, 2762493689]
    check_elf_and_hash('hash_funcs_sig1', 'JSHash', hash_vals, 'sig1')

def test_evaluate_ext_mem_refs_js_sig2():
    #hash_vals = [2762492226, 1110201004, 2935291980, 2762493689, 2762493661, 446421559, 337890280, 1677516465, 2935291988, 1611191246, 336721251, 2762493087, 2935291932, 1664134994, 1082640696, 1634480176, 446381510, 1110279722, 446399127, 1701216367, 446451528, 446460671, 1623919891, 2935292023, 1695673258, 1086324297, 1614930923, 446379991, 446413526, 446365814]
    hash_vals = [2762492226, 1110201004, 2935291980, 2762493689]
    check_elf_and_hash('hash_funcs_sig2', 'JSHash', hash_vals, 'sig2')

def test_evaluate_ext_mem_refs_sdbm_sig1():
    #hash_vals = [5904027, 3935519020, 98, 5051199, 5051235, 964107362, 1241303074, 1388341667, 106, 2592508254, 2651874758, 3739208, 50, 519225721, 1698863643, 1254941095, 856511046, 1599196740, 578046974, 138431324, 608797027, 674233110, 1680364252, 71, 194814422, 1977987686, 3354639924, 863919754, 716327795, 816449902]
    hash_vals = [5904027, 3935519020, 98, 5051199]
    check_elf_and_hash('hash_funcs_sig1', 'SDBMHash', hash_vals, 'sig1')

def test_evaluate_ext_mem_refs_sdbm_sig2():
    #hash_vals = [5904027, 3935519020, 98, 5051199, 5051235, 964107362, 1241303074, 1388341667, 106, 2592508254, 2651874758, 3739208, 50, 519225721, 1698863643, 1254941095, 856511046, 1599196740, 578046974, 138431324, 608797027, 674233110, 1680364252, 71, 194814422, 1977987686, 3354639924, 863919754, 716327795, 816449902]
    hash_vals = [5904027, 3935519020, 98, 5051199]
    check_elf_and_hash('hash_funcs_sig2', 'SDBMHash', hash_vals, 'sig2')

def test_evaluate_ext_mem_refs_djb_sig1():
    #hash_vals = [5862996, 2090848505, 177671, 5862526, 5862562, 193506295, 279502731, 195545384, 177679, 203161375, 278452749, 5861855, 177623, 257214844, 2089171668, 240614700, 193492085, 2090973105, 193456215, 234507439, 193459414, 193467829, 217301837, 177644, 223910547, 2088581065, 228373217, 193492735, 193473642, 193487267]
    hash_vals = [5862996, 2090848505, 177671, 5862526]
    check_elf_and_hash('hash_funcs_sig1', 'DJBHash', hash_vals, 'sig1')

def test_evaluate_ext_mem_refs_djb_sig2():
    #hash_vals = [5862996, 2090848505, 177671, 5862526, 5862562, 193506295, 279502731, 195545384, 177679, 203161375, 278452749, 5861855, 177623, 257214844, 2089171668, 240614700, 193492085, 2090973105, 193456215, 234507439, 193459414, 193467829, 217301837, 177644, 223910547, 2088581065, 228373217, 193492735, 193473642, 193487267]
    hash_vals = [5862996, 2090848505, 177671, 5862526]
    check_elf_and_hash('hash_funcs_sig2', 'DJBHash', hash_vals, 'sig2')

def test_evaluate_ext_mem_refs_elf_sig1():
    #hash_vals = [1557, 506873, 98, 1308, 1344, 31174, 8148857, 3596198, 106, 3981018, 8102436, 977, 50, 7004839, 317315, 6092465, 27844, 527569, 19667, 5805137, 20129, 22050, 4754805, 71, 5163955, 248017, 5390769, 27882, 23494, 26868]
    hash_vals = [1958, 1557, 506873, 98, 1308]
    check_elf_and_hash('hash_funcs_sig1', 'ELFHash', hash_vals, 'sig1')

def test_evaluate_ext_mem_refs_elf_sig2():
    #hash_vals = [1557, 506873, 98, 1308, 1344, 31174, 8148857, 3596198, 106, 3981018, 8102436, 977, 50, 7004839, 317315, 6092465, 27844, 527569, 19667, 5805137, 20129, 22050, 4754805, 71, 5163955, 248017, 5390769, 27882, 23494, 26868]
    hash_vals = [1557, 506873, 98, 1308]
    check_elf_and_hash('hash_funcs_sig2', 'ELFHash', hash_vals, 'sig2')

def test_evaluate_ext_mem_refs_ap_sig1():
    #hash_vals = [484507072, 3456059466, 3280568675, 2435263139, 2999834926, 1130506290, 4294733762, 1738922464, 3009353457, 1241470987, 1431655726, 90, 4275956630, 577808142, 2210368228, 1431655742, 1354933431, 2794944483, 3579139360, 3187509209, 778603036, 3455879286, 1431655714, 1526975839, 1789569669, 3770119646, 1591772012, 3127984299, 1441758241, 2617147401]
    hash_vals = [484507072, 3456059466, 3280568675, 2435263139]
    check_elf_and_hash('hash_funcs_sig1', 'APHash', hash_vals, 'sig1')

def test_evaluate_ext_mem_refs_ap_sig2():
    #hash_vals = [484507072, 3456059466, 3280568675, 2435263139, 2999834926, 1130506290, 4294733762, 1738922464, 3009353457, 1241470987, 1431655726, 90, 4275956630, 577808142, 2210368228, 1431655742, 1354933431, 2794944483, 3579139360, 3187509209, 778603036, 3455879286, 1431655714, 1526975839, 1789569669, 3770119646, 1591772012, 3127984299, 1441758241, 2617147401]
    hash_vals = [484507072, 3456059466, 3280568675, 2435263139]
    check_elf_and_hash('hash_funcs_sig2', 'APHash', hash_vals, 'sig2')

def check_elf_and_hash(elf_file_path, hash_func_name, hash_vals, sig):
    elf_file_path = os.path.join(test_location, elf_file_path)
    proj = angr.Project(elf_file_path, auto_load_libs=False)
    cfg = proj.analyses.CFGFast()

    hash_func = cfg.functions.function(name=hash_func_name)

    if sig == 'sig1':
        hash_func_evaluator = HashFuncEvaluatorSig1(elf_file_path, hash_func.addr, proj=proj)
    elif sig == 'sig2':
        hash_func_evaluator = HashFuncEvaluatorSig2(elf_file_path, hash_func.addr, proj=proj)
    else:
        raise Exception("Unknown signature: {}".format(sig))

    hash_func_name_arg_map = {'BKDRHash':'bkdr', 'DEKHash':'dek', 'PJWHash':'pjw', 'RSHash':'rs', 'JSHash':'js', 'SDBMHash':'sdbm', 'DJBHash':'djb', 'ELFHash':'elf', 'APHash':'ap'}
    hash_func_arg = hash_func_name_arg_map[hash_func_name]
    for hash_val in hash_vals:
        preimage = hash_func_evaluator.find_preimage(hash_val)

        assert_is_not_none(preimage, msg="We could not find a preimage for hash value: {} for hash function: {}".format(hash_val, hash_func_name))

        output = subprocess.check_output([elf_file_path, hash_func_arg, preimage]).strip()
        output_hash_val_regex = re.compile(b'\d+$')
        output_hash_val_match = re.search(output_hash_val_regex, output)
        assert_is_not_none(output_hash_val_match, msg='Could not find hash val in output: {}'.format(output))
        output_hash_val = int(output_hash_val_match.group(0))
        assert_equal(output_hash_val, hash_val, msg='The string {} is not a preimage for {} with hash function: {}'.format(preimage, hash_val, hash_func_name))


