from ubuntu:latest

ARG USER_ID
ARG GROUP_ID

ENV TZ=America/Los_Angeles
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

arg DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get dist-upgrade -y
RUN apt-get update
RUN apt-get install -y ca-certificates
RUN apt-get install -y software-properties-common
# Install pypy3
RUN add-apt-repository ppa:pypy/ppa
RUN apt-get update
RUN apt-get install -y pypy3
RUN apt-get install -y build-essential
RUN apt-get install -y git
RUN apt-get install -y cmake
RUN apt-get install -y wget
RUN apt-get install -y zip
RUN apt-get install -y curl
RUN apt-get install -y sudo
RUN apt-get install -y vim

RUN apt-get install -y autoconf
RUN apt-get install -y pkg-config
RUN apt-get install -y libtool
RUN apt-get install -y virtualenv
#RUN apt-get install -y virtualenvwrapper
RUN apt-get install -y pypy3-dev

RUN addgroup --gid $GROUP_ID user
RUN adduser --home /home/user/ --shell /bin/bash --disabled-password --uid $USER_ID --gid $GROUP_ID user
RUN passwd --delete user
RUN usermod -aG sudo user

USER user
WORKDIR /home/user

# Create the virtual environment
RUN virtualenv --without-pip -p /usr/bin/pypy3 angr
# Set PATH so that we first run the stuff in the venv
ENV PATH="/home/user/angr/bin:$PATH"
RUN curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
RUN pypy3 ./get-pip.py


RUN pypy3 -m pip install numpy
#RUN pypy3 -m pip install scipy
RUN pypy3 -m pip install matplotlib
RUN pypy3 -m pip install jsonpickle
RUN pypy3 -m pip install pygments 
RUN pypy3 -m pip install nose
RUN pypy3 -m pip install angr

# Install binalyzer
RUN pypy3 -m pip install git+https://github.com/usc-isi-bass/binalyzer

RUN mkdir -p /home/user/repos
WORKDIR /home/user/repos

## Install keystone
WORKDIR /home/user/repos/
RUN git clone https://github.com/keystone-engine/keystone

RUN mkdir /home/user/repos/keystone/build
WORKDIR /home/user/repos/keystone/build
RUN ../make-share.sh
USER root
RUN make install

USER user
RUN pypy3 -m pip install keystone-engine

WORKDIR /home/user
# Activate virtual env on startup
RUN sh -c 'echo "source /home/user/angr/bin/activate" >> /home/user/.bashrc'
