from ubuntu:latest

ENV TZ=America/Los_Angeles
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

arg DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get dist-upgrade -y
RUN apt-get install -y python3
RUN apt-get install -y python3-pip
RUN apt-get install -y build-essential
RUN apt-get install -y git
RUN apt-get install -y cmake
RUN apt-get install -y sympy

RUN apt-get install -y apt-utils
RUN apt-get install -y autoconf
RUN apt-get install -y pkg-config
RUN apt-get install -y libtool
# For graph_tool
RUN apt-get install -y  libboost-all-dev
RUN apt-get install -y libgmp3-dev
RUN apt-get install -y libcgal-dev
RUN apt-get install -y libcairomm-1.0-dev
#RUN apt-get install -y libpkgconfig-dev
RUN apt-get install -y libsparsehash-dev



RUN python3 -m pip install numpy
RUN python3 -m pip install scipy
RUN python3 -m pip install matplotlib
RUN python3 -m pip install pycairo
#RUN python3 -m pip install pgi
RUN python3 -m pip install jsonpickle
RUN python3 -m pip install pygments 
RUN python3 -m pip install nose


#RUN useradd -s /bin/bash -m angr

# Install angr

#RUN su - angr -c "mkdir /home/angr/repos"
RUN mkdir -p /home/angr/repos
#USER angr
WORKDIR /home/angr/repos

RUN git clone https://github.com/angr/archinfo
RUN git clone https://github.com/angr/pyvex
RUN git clone https://github.com/angr/claripy
RUN git clone https://github.com/angr/cle
RUN git clone https://github.com/angr/angr

WORKDIR /home/angr/repos
#RUN cd archinfo && python3 -m pip install -e .
#RUN python3 -m pip install --user -e ./archinfo
#RUN python3 -m pip install --user -e ./pyvex
#RUN python3 -m pip install --user -e ./claripy
#RUN python3 -m pip install --user -e ./cle
#RUN python3 -m pip install --user -e ./angr
RUN python3 -m pip install -e ./archinfo
RUN python3 -m pip install -e ./pyvex
RUN python3 -m pip install -e ./claripy
RUN python3 -m pip install -e ./cle
RUN python3 -m pip install -e ./angr


# Install keystone
RUN git clone https://github.com/keystone-engine/keystone
RUN mkdir keystone/build
WORKDIR /home/angr/repos/keystone/build
RUN ../make-share.sh
#USER root
RUN make install

RUN python3 -m pip install keystone-engine

WORKDIR /home/angr/repos

#USER angr
RUN git clone https://git.skewed.de/count0/graph-tool.git
WORKDIR /home/angr/repos/graph-tool
RUN ./autogen.sh
RUN ./configure
RUN make -j 15
#USER root
RUN make install
RUN mkdir /usr/local/lib/python3.8/site-packages/
RUN ln -s /usr/lib/python3/dist-packages/graph_tool /usr/local/lib/python3.8/site-packages/graph_tool

# Install Ghidra
RUN python3 -m pip install ghidra_bridge
RUN wget https://ghidra-sre.org/ghidra_9.1.2_PUBLIC_20200212.zip && \
    unzip ghidra_9.1.2_PUBLIC_20200212.zip && \
    mkdir -p /opt/ghidra && \
    mv ghidra_9.1.2_PUBLIC/* /opt/ghidra && \
    rm -rf ghidra_9.1.2_PUBLIC ghidra_9.1.2_PUBLIC_20200212.zip
RUN apt-get install -y openjdk-11-jdk

#USER angr
WORKDIR /home/angr
