import argparse
import sys
import os
import logging

# Because apparently python only adds the parent directory of the running script to the PATH.
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from binalyzer.analyzers.parallel_analyzer import ParallelAnalyzer
from binalyzer.util.analyzer_argument_parser import ParallelAnalyzerArgumentParser

from analyses.hash_func_discovery.hash_func_discovery_analysis import HashFuncDiscoveryAnalysis

logging.getLogger('angr').setLevel(logging.CRITICAL)
logging.getLogger('cle').setLevel(logging.CRITICAL)
logging.getLogger('claripy').setLevel(logging.CRITICAL)

def main():
    analyzer_argument_parser = ParallelAnalyzerArgumentParser()

    parser = argparse.ArgumentParser('Search for hash functions in binary executables.', parents=[analyzer_argument_parser])
    parser.add_argument('--score_cutoff', default=80, help='The cutoff score at which to consider a classification correct.', type=int)

    args = parser.parse_args()
    root_dir = args.root_dir
    elf_list = args.elf_list
    nthreads = args.nthreads
    similarity_score_cutoff = args.score_cutoff
    results_path = args.results_path
   
    analysis = HashFuncDiscoveryAnalysis(similarity_score_cutoff)
    par_analyzer = ParallelAnalyzer(analysis, root_dir=root_dir, elf_list=elf_list, nthreads=nthreads, results_path=results_path)
    par_analyzer.run_analysis()

if __name__ == "__main__":
    main()
